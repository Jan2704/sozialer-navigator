---
import Layout from '../../layouts/Layout.astro';

// Hinweis: In einer Produktionsumgebung w√ºrdest du hier eine 
// Authentifizierung (Login) vorschalten.
---

<Layout title="Partner Dashboard | Lead-Verwaltung">
  <main style="max-width: 1200px; margin: 0 auto; padding: 40px 20px; font-family: 'Inter', sans-serif;">
    
    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 3rem; border-bottom: 2px solid #f1f5f9; padding-bottom: 20px;">
      <div>
        <h1 style="font-size: 2rem; font-weight: 900; color: #0f172a; margin: 0;">Partner-Dashboard</h1>
        <p style="color: #64748b; margin: 5px 0 0 0;">Verwaltung der eingegangenen Anspr√ºche & AVGS-Leads</p>
      </div>
      <div style="text-align: right;">
        <span id="sync-status" style="font-size: 0.75rem; font-weight: 800; color: #16a34a; background: #f0fdf4; padding: 5px 12px; border-radius: 99px; text-transform: uppercase;">‚óè Live verbunden</span>
      </div>
    </header>

    <section style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 3rem;">
      <div style="background: white; padding: 25px; border-radius: 24px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
        <span style="color: #64748b; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;">Leads Gesamt</span>
        <div id="stat-total" style="font-size: 2.5rem; font-weight: 900; color: #0f172a;">0</div>
      </div>
      <div style="background: #eff6ff; padding: 25px; border-radius: 24px; border: 1px solid #dbeafe; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
        <span style="color: #2563eb; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;">AVGS Potenzial (Coaching)</span>
        <div id="stat-avgs" style="font-size: 2.5rem; font-weight: 900; color: #2563eb;">0</div>
      </div>
      <div style="background: white; padding: 25px; border-radius: 24px; border: 1px solid #e2e8f0; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05);">
        <span style="color: #64748b; font-size: 0.85rem; font-weight: 700; text-transform: uppercase;">Fristwahrungen Heute</span>
        <div style="font-size: 2.5rem; font-weight: 900; color: #0f172a;">2026</div>
      </div>
    </section>

    <section style="background: white; border-radius: 32px; border: 1px solid #e2e8f0; overflow: hidden; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);">
      <div style="padding: 25px; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="margin: 0; font-weight: 800;">Aktuelle Leads</h3>
        <button onclick="loadLeads()" style="background: #f1f5f9; border: none; padding: 8px 15px; border-radius: 8px; font-weight: 700; cursor: pointer; color: #475569;">Aktualisieren ‚Üª</button>
      </div>
      <div style="overflow-x: auto;">
        <table style="width: 100%; border-collapse: collapse; text-align: left;">
          <thead>
            <tr style="background: #f8fafc; border-bottom: 1px solid #f1f5f9;">
              <th style="padding: 20px; font-size: 0.75rem; text-transform: uppercase; color: #64748b;">Datum</th>
              <th style="padding: 20px; font-size: 0.75rem; text-transform: uppercase; color: #64748b;">Name / Stadt</th>
              <th style="padding: 20px; font-size: 0.75rem; text-transform: uppercase; color: #64748b;">Einkommen</th>
              <th style="padding: 20px; font-size: 0.75rem; text-transform: uppercase; color: #64748b;">Anspruch</th>
              <th style="padding: 20px; font-size: 0.75rem; text-transform: uppercase; color: #64748b;">AVGS</th>
              <th style="padding: 20px; font-size: 0.75rem; text-transform: uppercase; color: #64748b;">Aktion</th>
            </tr>
          </thead>
          <tbody id="lead-table-body">
            </tbody>
        </table>
      </div>
    </section>

  </main>
</Layout>

<script is:inline type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';
  
  const SUPABASE_URL = 'https://iiimjuplyjqapvwhbozf.supabase.co'; 
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlpaW1qdXBseWpxYXB2d2hib3pmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU2NTI4MTgsImV4cCI6MjA4MTIyODgxOH0.Ru-09I4PuFQsJC-AMcdntn9bCS2f9lOdGQoMo7fAHYs';
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  async function loadLeads() {
    const tableBody = document.getElementById('lead-table-body');
    tableBody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #64748b;">Lade Daten...</td></tr>';

    const { data, error } = await supabase
      .from('master_claims_2026')
      .select('*')
      .order('created_at', { ascending: false });

    if (error) {
      console.error(error);
      tableBody.innerHTML = '<tr><td colspan="6" style="padding: 40px; text-align: center; color: #ef4444;">Fehler beim Laden!</td></tr>';
      return;
    }

    // Statistiken aktualisieren
    document.getElementById('stat-total').innerText = data.length;
    document.getElementById('stat-avgs').innerText = data.filter(l => l.avgs_interest).length;

    tableBody.innerHTML = '';
    data.forEach(lead => {
      const date = new Date(lead.created_at).toLocaleDateString('de-DE');
      tableBody.innerHTML += `
        <tr style="border-bottom: 1px solid #f1f5f9; hover: background: #f8fafc;">
          <td style="padding: 20px; font-size: 0.9rem; color: #64748b;">${date}</td>
          <td style="padding: 20px;">
            <div style="font-weight: 800; color: #0f172a;">${lead.full_name}</div>
            <div style="font-size: 0.75rem; color: #64748b;">üìç ${lead.city}</div>
          </td>
          <td style="padding: 20px; font-weight: 600;">${lead.income} ‚Ç¨</td>
          <td style="padding: 20px; color: #16a34a; font-weight: 800;">+ ${lead.total_claim_value} ‚Ç¨</td>
          <td style="padding: 20px;">
            ${lead.avgs_interest 
              ? '<span style="background: #dcfce7; color: #166534; padding: 4px 10px; border-radius: 6px; font-size: 0.7rem; font-weight: 900;">B√úRO-CHECK</span>' 
              : '<span style="color: #cbd5e1; font-size: 0.7rem;">-</span>'}
          </td>
          <td style="padding: 20px;">
            <button style="background: #0f172a; color: white; border: none; padding: 8px 15px; border-radius: 8px; font-size: 0.8rem; font-weight: 700; cursor: pointer;">Details</button>
          </td>
        </tr>
      `;
    });
  }

  // Initiales Laden
  window.loadLeads = loadLeads;
  loadLeads();
</script>