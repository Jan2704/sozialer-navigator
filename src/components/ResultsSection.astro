---
// src/components/ResultsSection.astro
import ResultRoadmap from './ResultRoadmap.astro';
import BenefitRecommendations from './BenefitRecommendations.astro';
import LeadModal from './LeadModal.astro';
---

<section id="view-results" class="view-section max-w-5xl mx-auto hidden opacity-0 transition-opacity duration-500 pt-32 pb-24 px-6 relative z-20">
    
    <!-- Header with Print/Reset -->
    <div class="mb-10 flex items-center justify-between">
         <div class="flex items-center gap-4">
             <button id="btn-back-home" class="md:hidden p-2 -ml-2 text-slate-400 hover:text-slate-900 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
             </button>
             <div>
                 <h2 class="text-2xl font-bold text-slate-900 tracking-tight">Ergebnis f√ºr <span class="text-blue-600" id="res-city-header">--</span></h2>
                 <p class="text-sm text-slate-500 mt-1">Unverbindliche Ersteinsch√§tzung</p>
             </div>
         </div>
         <div class="flex gap-3">
            <button id="btn-recalc" class="px-4 py-2 rounded-xl bg-white hover:bg-slate-50 text-slate-600 hover:text-slate-900 text-sm font-medium transition-colors flex items-center gap-2 border border-slate-200 shadow-sm">
                 <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 0 0-9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path><path d="M3 12a9 9 0 0 0 9 9 9.75 9.75 0 0 0 6.74-2.74L21 16"></path><path d="M16 21h5v-5"></path></svg>
                 Neu berechnen
            </button>
            <button onclick="window.print()" class="hidden md:flex px-4 py-2 rounded-xl bg-white hover:bg-slate-50 text-slate-600 hover:text-slate-900 text-sm font-medium transition-colors items-center gap-2 border border-slate-200 shadow-sm">
                 <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9V2h12v7"></path><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><path d="M6 14h12v8H6z"></path></svg>
                 Drucken
            </button>
         </div>
    </div>

    <!-- Bento Grid (Dark Kelvin Style) -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <!-- Hero Card (Amount) - Span 2 -->
        <div class="col-span-1 md:col-span-2 bg-white border border-slate-200 p-8 rounded-3xl relative overflow-hidden flex flex-col justify-between min-h-[280px] shadow-xl">
            <!-- Background Glow -->
            <div class="absolute top-0 right-0 w-64 h-64 bg-blue-50 rounded-full blur-3xl -mr-16 -mt-16 pointer-events-none opacity-60"></div>
            
            <div class="relative z-10">
                <div class="inline-flex items-center gap-2 bg-emerald-50 text-emerald-600 border border-emerald-100 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-widest mb-6">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></span>
                    Anspruch berechnet
                </div>
                <h3 class="text-slate-500 font-medium text-lg mb-2">Ihr voraussichtlicher Zuschuss</h3>
                <div class="flex items-baseline gap-2">
                     <span id="res-amount-hero" class="text-7xl font-black text-slate-900 tracking-tighter">0‚Ç¨</span>
                     <span class="text-xl text-slate-500 font-medium">/ Monat</span>
                </div>
                <p id="res-type-hero" class="text-blue-600 font-bold text-xl mt-2 tracking-wide">Wohngeld</p>
            </div>
            <div class="mt-8 pt-6 border-t border-slate-100 relative z-10">
                <p class="text-xs text-slate-400">
                    *Dies ist eine unverbindliche Berechnung auf Basis Ihrer Eingaben. <span id="res-context-text"></span>
                </p>
            </div>
        </div>

        <!-- Analysis Card (Chart) - Span 1 -->
        <div class="col-span-1 bg-white border border-slate-200 p-6 rounded-3xl flex flex-col items-center justify-center relative shadow-xl">
             <h4 class="absolute top-6 left-6 text-xs font-bold text-slate-400 uppercase tracking-wider">Entlastung</h4>
             <div class="relative w-40 h-40 mt-4">
                 <canvas id="analysisChart"></canvas>
                 <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                     <span class="text-2xl font-black text-slate-900" id="analysis-percent">0%</span>
                 </div>
             </div>
             <p class="text-center text-xs text-slate-500 mt-4 font-medium">der Miete gedeckt</p>
        </div>

        <!-- City Card - Span 3 (Full Width) -->
         <div class="col-span-1 md:col-span-3 bg-white border border-slate-200 p-8 rounded-3xl relative overflow-hidden text-slate-900 shadow-xl">
             <!-- Subtle back gradient -->
             <div class="absolute inset-0 bg-gradient-to-r from-slate-50/50 to-transparent pointer-events-none"></div>

            <div class="relative z-10 flex flex-col md:flex-row md:items-start justify-between gap-6">
                <div>
                     <h4 class="text-slate-400 font-bold text-xs uppercase tracking-widest mb-3">Zust√§ndigkeit</h4>
                     <h3 class="text-2xl font-bold tracking-tight mb-1 text-slate-900" id="city-card-name">--</h3>
                     <p class="text-sm text-slate-500 mb-4" id="city-card-amt">Beh√∂rde</p>
                     
                     <!-- Disclaimer -->
                     <div class="flex items-start gap-2 mb-6 max-w-sm">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-blue-500 shrink-0 mt-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>
                        <p class="text-xs text-slate-400 leading-relaxed">
                            Hinweis: Je nach Stadtbezirk oder Wohnviertel kann eine andere lokale Beh√∂rde zust√§ndig sein.
                        </p>
                     </div>
                     
                     <div class="inline-flex items-center gap-3 bg-slate-50 border border-slate-100 px-4 py-2 rounded-xl">
                        <span class="text-xl">üìç</span>
                        <div>
                            <span class="block text-[10px] text-slate-400 uppercase font-bold">Mietstufe</span>
                            <span class="block text-lg font-bold text-slate-900" id="city-card-level">--</span>
                        </div>
                     </div>
                </div>
                
                <div class="pt-2">
                    <a href="#" target="_blank" id="city-card-link" class="hidden px-6 py-3 rounded-xl bg-blue-600 hover:bg-blue-700 text-white font-bold transition-all shadow-lg hover:shadow-blue-500/25 flex items-center gap-2 text-sm">
                        <span>Beh√∂rde kontaktieren</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 ml-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                    </a>
                </div>
            </div>
         </div>
         
         <!-- ROADMAP / FAHRPLAN - Span 3 -->
         <div class="col-span-1 md:col-span-3">
             <ResultRoadmap />
         </div>
         

         
         <!-- RECOMMENDATIONS - Span 3 -->
         <div class="col-span-1 md:col-span-3">
             <BenefitRecommendations />
         </div>
         

    </div>
    
    <!-- Modals -->
    <LeadModal />
</section>

<script>
    import Chart from 'chart.js/auto';

    // Helper: Show results view (Global)
    window.showView = (viewId) => {
        const views = document.querySelectorAll('.view-section');
        views.forEach(el => {
            el.classList.add('hidden', 'opacity-0');
            el.classList.remove('active', 'opacity-100');
            el.style.display = 'none';
        });
        
        const target = document.getElementById('view-' + viewId);
        if (target) {
            target.classList.remove('hidden');
            target.style.display = 'block';
            setTimeout(() => {
                target.classList.add('active', 'opacity-100');
                target.classList.remove('opacity-0');
            }, 10);
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    };

    window.addEventListener('benefit-calculation-completed', (e) => {
        const result = e.detail;
        const { input, amount, type, details } = result;

        window.showView('results');

       // Hero Values
       const amountEl = document.getElementById('res-amount-hero');
       if(amountEl) amountEl.textContent = amount.toFixed(0) + "‚Ç¨";
       
       const typeEl = document.getElementById('res-type-hero');
       if(typeEl) {
           typeEl.textContent = type;
           // Color Coding
           if (type === 'B√ºrgergeld') {
               typeEl.classList.remove('text-blue-400');
               typeEl.classList.add('text-amber-400');
           } else {
               typeEl.classList.add('text-blue-600');
               typeEl.classList.remove('text-amber-500');
           }
       }

       const contextEl = document.getElementById('res-context-text');
       if(contextEl && input.city) contextEl.textContent = `Basierend auf Ihren Angaben f√ºr ${input.city.stadt}.`;

       const headerCityEl = document.getElementById('res-city-header');
       if(headerCityEl) headerCityEl.textContent = input.city ? input.city.stadt : '-';

       // Analysis Chart (Donut)
       try {
           const ctx = document.getElementById('analysisChart');
           if (ctx) {
                 const existingChart = Chart.getChart("analysisChart");
                 if (existingChart) existingChart.destroy();
    
                 const rent = input.rent;
                 // Logic: Amount covers X% of Rent
                 const percentCovered = rent > 0 ? Math.min(100, Math.round((amount / rent) * 100)) : 0;
                 
                 const percentEl = document.getElementById('analysis-percent');
                 if(percentEl) percentEl.textContent = percentCovered + "%";
    
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        datasets: [{
                            data: [percentCovered, 100 - percentCovered],
                            backgroundColor: ['#3b82f6', '#e2e8f0'], // Blue-500 / Slate-200 (Light)
                            borderWidth: 0,
                            borderRadius: 20
                        }]
                    },
                    options: { cutout: '85%', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } } }
                });
           }
       } catch (chartErr) {
           console.warn("Chart Error:", chartErr);
       }

        // Limit Card / Rent Check
        try {
            // Logic: Compare Rent to Eligible Rent (details.eligibleRent)
            if(details && details.eligibleRent) {
                const isOverLimit = input.rent > details.eligibleRent;
                const limitCurrent = document.getElementById('limit-current');
                const limitMax = document.getElementById('limit-max');
                
                if (limitCurrent) limitCurrent.textContent = input.rent + " ‚Ç¨";
                if (limitMax) limitMax.textContent = details.eligibleRent + " ‚Ç¨";
                
                const fillInPercent = (input.rent / (details.eligibleRent * 1.5)) * 100;
                const limitBar = document.getElementById('limit-bar-fill');
                if(limitBar) {
                    limitBar.style.width = Math.min(100, fillInPercent) + "%";
                    limitBar.classList.toggle('bg-red-500', isOverLimit);
                    limitBar.classList.toggle('bg-emerald-500', !isOverLimit);
                }
                
                // Update Text Context
                const limitTitle = document.getElementById('limit-title'); // Need to add ID
                if(limitTitle) limitTitle.textContent = isOverLimit ? "√úber der Grenze" : "Im Rahmen";
            }
        } catch (limitErr) {
            console.warn("Limit Card Error:", limitErr);
        }

       // City Card
       try {
           if(input.city) {
               const nameEl = document.getElementById('city-card-name');
               const levelEl = document.getElementById('city-card-level');
               const amtEl = document.getElementById('city-card-amt');
               
               if(nameEl) nameEl.textContent = input.city.stadt;
               if(levelEl) levelEl.textContent = input.city.mietstufe;
               if(amtEl && input.city.amt_name) amtEl.textContent = input.city.amt_name;
               
               // City Link Logic
               const linkEl = document.getElementById('city-card-link');
               if(linkEl) {
                   // Use provided URL or fallback to Google Search
                   const url = input.city.amt_url || `https://www.google.com/search?q=Wohngeldstelle+${encodeURIComponent(input.city.stadt)}`;
                   linkEl.href = url;
                   linkEl.classList.remove('hidden');
                   linkEl.classList.add('flex');
               }
           } else {
                const nameEl = document.getElementById('city-card-name');
                const levelEl = document.getElementById('city-card-level');
                const linkEl = document.getElementById('city-card-link');
                
                if(nameEl) nameEl.textContent = "Ihre Stadt";
                if(levelEl) levelEl.textContent = "-";
                if(linkEl) linkEl.classList.add('hidden');
           }
       } catch (cityErr) {
           console.error("City Card Error:", cityErr);
       }

        // DYNAMIC LEADS LOGIC (Restored)
        // 1. Check if B√ºrgergeld or KiZ is better

        
        // RECOMMENDATIONS LOGIC
        try {
            const recSection = document.getElementById('rec-section');
            const cardKiZ = document.getElementById('rec-card-kiz');
            const cardBuT = document.getElementById('rec-card-but');
            
            if (recSection) {
                recSection.classList.remove('hidden'); // Show section generally
                
                const hasKids = input.kids > 0;
                
                if (cardKiZ) {
                    if (hasKids) {
                       cardKiZ.classList.remove('hidden');
                       cardKiZ.classList.add('block');
                    } else {
                       cardKiZ.classList.add('hidden');
                       cardKiZ.classList.remove('block');
                    }
                }
    
                if (cardBuT) {
                    if (hasKids) {
                       cardBuT.classList.remove('hidden');
                       cardBuT.classList.add('block');
                    } else {
                       cardBuT.classList.add('hidden');
                       cardBuT.classList.remove('block');
                    }
                }
                
                // AVGS is always shown
            }
        } catch (recErr) {
            console.warn("Recommendations Error:", recErr);
        }


       // Confetti
        if (result.eligible && window.confetti) {
             window.confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#2957FF', '#ffffff'] });
        }
    });

    // Re-Calc Button
    document.getElementById('btn-recalc')?.addEventListener('click', () => {
         if(window.resetCitySearch) window.resetCitySearch();
         if(window.showView) window.showView('home');
         else window.location.reload();
    });
</script>
